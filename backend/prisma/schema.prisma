// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER & AUTH ====================
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  firstName     String?
  lastName      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  aircraft      Aircraft[]
  flightPlans   FlightPlan[]
  
  @@map("users")
}

// ==================== AIRCRAFT ====================
model Aircraft {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  registration    String
  type            String
  name            String?
  
  // Performance data
  cruiseSpeed     Float
  fuelConsumption Float
  fuelUnit        FuelUnit  @default(LITERS)
  
  // Weight & Balance
  emptyWeight     Float
  maxTakeoffWeight Float
  usableFuel      Float
  
  // Arm positions (for CG calculation)
  emptyWeightArm      Float?
  fuelArm             Float?
  frontSeatArm        Float?
  rearSeatArm         Float?
  baggageArm          Float?
  
  // Limits
  forwardCGLimit      Float?
  aftCGLimit          Float?
  maxBaggageWeight    Float?
  
  // CG Envelope
  cgEnvelope          Json?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  flightPlans     FlightPlan[]
  
  @@map("aircraft")
}

enum FuelUnit {
  LITERS
  GALLONS
}

// airports 
model Airport {
  id              String    @id @default(uuid())
  icaoCode        String    @unique
  iataCode        String?
  name            String
  city            String?
  country         String
  
  latitude        Float
  longitude       Float
  elevation       Int
  
  // Airport type
  airportType     AirportType @default(VFR)
  hasWeatherStation Boolean @default(false)
  
  // Frequencies
  towerFreq       String?
  groundFreq      String?
  atisFreq        String?
  approachFreq    String?
  afisFreq        String?
  
  // Additional info
  fuelAvailable   Boolean   @default(false)
  lightingAvail   Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  runways         Runway[]
  
  departures      FlightPlan[] @relation("DepartureAirport")
  arrivals        FlightPlan[] @relation("ArrivalAirport")
  alternates      FlightPlan[] @relation("AlternateAirport")
  waypoints       Waypoint[]
  
  @@map("airports")
}

enum AirportType {
  IFR
  VFR
  MIL
}

model Runway {
  id              String    @id @default(uuid())
  airportId       String
  airport         Airport   @relation(fields: [airportId], references: [id], onDelete: Cascade)
  
  designation     String
  length          Int
  width           Int
  surface         String
  heading         Int
  
  threshold1Lat   Float?
  threshold1Lon   Float?
  threshold2Lat   Float?
  threshold2Lon   Float?
  
  @@map("runways")
}

// FLIGHT PLAN 
model FlightPlan {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name            String?
  
  // Aircraft
  aircraftId      String?
  aircraft        Aircraft? @relation(fields: [aircraftId], references: [id])
  
  // Airports
  departureId     String?
  departure       Airport?  @relation("DepartureAirport", fields: [departureId], references: [id])
  arrivalId       String?
  arrival         Airport?  @relation("ArrivalAirport", fields: [arrivalId], references: [id])
  alternateId     String?
  alternate       Airport?  @relation("AlternateAirport", fields: [alternateId], references: [id])
  
  // Flight details
  plannedDate     DateTime?
  plannedTime     String?
  cruiseAltitude  Int?
  cruiseSpeed     Float?
  
  // W&B
  pilotWeight     Float?
  passengerWeight Float?
  baggageWeight   Float?
  fuelWeight      Float?
  
  // Calculated values
  totalDistance   Float?
  totalTime       Int?
  fuelRequired    Float?
  
  // Status
  status          FlightPlanStatus @default(DRAFT)
  
  // Route
  waypoints       Waypoint[]
  legs            FlightLeg[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("flight_plans")
}

enum FlightPlanStatus {
  DRAFT
  PLANNED
  ACTIVE
  COMPLETED
  CANCELLED
}

// WAYPOINTS
model Waypoint {
  id              String    @id @default(uuid())
  flightPlanId    String
  flightPlan      FlightPlan @relation(fields: [flightPlanId], references: [id], onDelete: Cascade)
  
  sequence        Int
  name            String
  type            WaypointType
  
  latitude        Float
  longitude       Float
  altitude        Int?
  
  // Optional link to airport
  airportId       String?
  airport         Airport?  @relation(fields: [airportId], references: [id])
  
  notes           String?
  
  createdAt       DateTime  @default(now())
  
  legFrom         FlightLeg[] @relation("LegFrom")
  legTo           FlightLeg[] @relation("LegTo")
  
  @@map("waypoints")
}

enum WaypointType {
  AIRPORT
  VOR
  NDB
  FIX
  GPS
  VISUAL
}

// FLIGHT LEGS
model FlightLeg {
  id              String    @id @default(uuid())
  flightPlanId    String
  flightPlan      FlightPlan @relation(fields: [flightPlanId], references: [id], onDelete: Cascade)
  
  sequence        Int
  
  fromWaypointId  String
  fromWaypoint    Waypoint  @relation("LegFrom", fields: [fromWaypointId], references: [id])
  toWaypointId    String
  toWaypoint      Waypoint  @relation("LegTo", fields: [toWaypointId], references: [id])
  
  // Calculated navigation data
  distance        Float
  trueCourse      Float
  magneticCourse  Float
  windCorrection  Float?
  heading         Float?
  groundSpeed     Float?
  
  // Time
  ete             Int?
  eta             String?
  
  // Fuel for this leg
  fuelBurn        Float?
  
  // Wind data used
  windDirection   Int?
  windSpeed       Int?
  
  createdAt       DateTime  @default(now())
  
  @@map("flight_legs")
}

// WEATHER CACHE
model WeatherData {
  id              String    @id @default(uuid())
  icaoCode        String
  type            WeatherType
  
  rawData         String
  parsedData      Json?
  
  validFrom       DateTime
  validTo         DateTime?
  
  fetchedAt       DateTime  @default(now())
  
  @@unique([icaoCode, type])
  @@map("weather_data")
}

enum WeatherType {
  METAR
  TAF
  GAMET
}

// NOTAM CACHE
model NotamData {
  id              String    @id @default(uuid())
  icaoCode        String
  notamId         String
  
  rawText         String
  type            String?
  
  effectiveFrom   DateTime
  effectiveTo     DateTime?
  
  fetchedAt       DateTime  @default(now())
  
  @@map("notam_data")
}
